{% extends "base.html" %}

{% block title %}Configuration - Temporal Monitoring{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Processing Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="config-form">
                    <div class="row">
                        <!-- Multitaper Parameters -->
                        <div class="col-lg-6 mb-4">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-wave-square me-1"></i>Multitaper Analysis
                            </h6>
                            
                            <div class="mb-3">
                                <label for="multitaper_bandwidth" class="form-label">Time-Bandwidth Product (NW)</label>
                                <input type="number" class="form-control" id="multitaper_bandwidth" 
                                       value="4.0" step="0.1" min="1" max="10">
                                <div class="form-text">
                                    <strong>Description:</strong> Controls the frequency resolution versus variance trade-off in multitaper spectral analysis. 
                                    Higher values (6-8) provide better frequency resolution but increase spectral variance. 
                                    Lower values (2-3) reduce variance but decrease frequency resolution. 
                                    Standard value of 4.0 provides optimal balance for most timing signal analysis applications.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="multitaper_samples" class="form-label">Number of Tapers (K)</label>
                                <input type="number" class="form-control" id="multitaper_samples" 
                                       value="7" min="1" max="20">
                                <div class="form-text">
                                    <strong>Description:</strong> Number of orthogonal DPSS (Discrete Prolate Spheroidal Sequence) tapers used for spectral estimation. 
                                    Maximum reliable number is typically 2*NW-1. More tapers reduce spectral variance but require more computation. 
                                    Optimal range is 5-9 for NW=4. Each taper provides an independent spectral estimate that gets averaged for robustness.
                                </div>
                            </div>
                        </div>

                        <!-- Coherence Parameters -->
                        <div class="col-lg-6 mb-4">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-signal me-1"></i>Coherence Analysis
                            </h6>
                            
                            <div class="mb-3">
                                <label for="coherence_threshold" class="form-label">Coherence Threshold</label>
                                <input type="number" class="form-control" id="coherence_threshold" 
                                       value="0.1" step="0.01" min="0" max="1">
                                <div class="form-text">
                                    <strong>Description:</strong> Minimum cross-spectral coherence level required for detecting coherent signals between timing references. 
                                    Values closer to 1.0 indicate stronger coherence. Lower thresholds (0.05-0.1) increase sensitivity but may produce false positives. 
                                    Higher thresholds (0.2-0.5) reduce false alarms but may miss weak coherent signals. 
                                    Standard value 0.1 provides good balance for gravitational timing interferometry applications.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="phase_smoothing_window" class="form-label">Phase Smoothing Window</label>
                                <input type="number" class="form-control" id="phase_smoothing_window" 
                                       value="50" min="3" max="200">
                                <div class="form-text">
                                    <strong>Description:</strong> Moving average window size (in data points) for smoothing phase gap calculations. 
                                    Larger windows (100-200) provide more stable phase estimates but reduce temporal resolution. 
                                    Smaller windows (10-30) preserve transient features but increase noise sensitivity. 
                                    Standard value 50 balances noise reduction with responsiveness to genuine phase variations.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Bayesian Parameters -->
                        <div class="col-lg-6 mb-4">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-chart-bar me-1"></i>Bayesian Analysis
                            </h6>
                            
                            <div class="mb-3">
                                <label for="bayes_factor_threshold" class="form-label">Bayes Factor Threshold</label>
                                <input type="number" class="form-control" id="bayes_factor_threshold" 
                                       value="10.0" step="1" min="1" max="100">
                                <div class="form-text">
                                    <strong>Description:</strong> Minimum natural logarithm of Bayes Factor required for decisive evidence in model comparison. 
                                    ln(BF) > 10 indicates very strong evidence, ln(BF) > 5 indicates strong evidence, ln(BF) > 2 indicates positive evidence. 
                                    Higher thresholds (20-50) require stronger evidence before triggering alerts but reduce false positives. 
                                    Standard value 10.0 follows Jeffreys' scale for scientific evidence evaluation.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="prior_strength" class="form-label">Prior Strength</label>
                                <input type="number" class="form-control" id="prior_strength" 
                                       value="1.0" step="0.1" min="0.1" max="10">
                                <div class="form-text">
                                    <strong>Description:</strong> Strength parameter for prior probability distributions in Bayesian model selection. 
                                    Higher values (2-5) increase confidence in prior assumptions and require stronger evidence to change beliefs. 
                                    Lower values (0.1-0.5) make the analysis more data-driven with weaker prior influence. 
                                    Standard value 1.0 provides balanced weighting between prior knowledge and observed data.
                                </div>
                            </div>
                        </div>

                        <!-- Mesh Monitor Configuration -->
                        <div class="col-lg-6 mb-4">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-network-wired me-1"></i>Mesh Monitor
                            </h6>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="use_mesh_monitor" checked>
                                    <label class="form-check-label" for="use_mesh_monitor">
                                        Enable Mesh Network Monitoring
                                    </label>
                                </div>
                                <div class="form-text">
                                    <strong>Description:</strong> Enable decentralized timing anomaly detection via NTP peer monitoring. 
                                    When enabled, the system will poll configured NTP peers to detect global timing synchronization issues. 
                                    This provides an independent check on timing stability separate from the main GTI pipeline. 
                                    Mesh monitoring can help distinguish between astrophysical anomalies and global synchrony events.
                                </div>
                            </div>
                            
                            <div class="mb-3" id="mesh_peers_config">
                                <label for="mesh_peers" class="form-label">NTP Peers</label>
                                <textarea class="form-control" id="mesh_peers" rows="3" 
                                          placeholder="pool.ntp.org&#10;time.nist.gov&#10;time.google.com">pool.ntp.org
time.nist.gov
time.google.com
ptbtime1.ptb.de</textarea>
                                <div class="form-text">
                                    <strong>Description:</strong> List of NTP server hostnames or IP addresses to monitor (one per line). 
                                    More peers provide better redundancy and accuracy but increase network overhead. 
                                    Recommended: 4-8 geographically distributed, high-quality time servers from national labs or major providers.
                                </div>
                            </div>
                            
                            <div class="mb-3" id="mesh_interval_config">
                                <label for="mesh_interval" class="form-label">Polling Interval (seconds)</label>
                                <input type="number" class="form-control" id="mesh_interval" 
                                       value="60" min="10" max="3600">
                                <div class="form-text">
                                    <strong>Description:</strong> Time interval between NTP peer polling cycles. 
                                    Shorter intervals (10-30s) provide faster anomaly detection but increase network load. 
                                    Longer intervals (300-3600s) reduce overhead but may miss transient events. 
                                    Standard value 60s balances responsiveness with resource usage.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- GTI Alert Thresholds -->
                        <div class="col-lg-6 mb-4">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>GTI Alert Thresholds
                            </h6>
                            
                            <div class="mb-3">
                                <label for="gti_critical" class="form-label">Critical Level</label>
                                <input type="number" class="form-control" id="gti_critical" 
                                       value="0.2" step="0.01" min="0" max="1">
                                <div class="form-text text-danger">
                                    <strong>Description:</strong> Critical GTI threshold indicating maximum allowed deviation from expected timing behavior. 
                                    Values above this level trigger immediate alerts and require urgent investigation. 
                                    Represents potential systematic breakdown in timing reference synchronization that could indicate fundamental physics anomalies. 
                                    Standard value 0.2 corresponds to 20% deviation from baseline timing correlations.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="gti_high" class="form-label">High Level</label>
                                <input type="number" class="form-control" id="gti_high" 
                                       value="0.1" step="0.01" min="0" max="1">
                                <div class="form-text text-warning">
                                    <strong>Description:</strong> High alert threshold for elevated GTI activity requiring increased monitoring attention. 
                                    Indicates significant but non-critical deviations in timing correlations across reference systems. 
                                    May suggest emerging systematic effects or environmental influences on timing precision. 
                                    Standard value 0.1 provides early warning before reaching critical levels.
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="gti_medium" class="form-label">Medium Level</label>
                                        <input type="number" class="form-control" id="gti_medium" 
                                               value="0.05" step="0.01" min="0" max="1">
                                        <div class="form-text text-info">
                                            <strong>Description:</strong> Medium alert threshold for moderate GTI activity warranting routine monitoring. 
                                            Represents normal operational fluctuations in timing system correlations. 
                                            Useful for trend analysis and establishing baseline performance metrics. 
                                            Standard value 0.05 captures typical day-to-day timing variations.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label for="gti_low" class="form-label">Low Level</label>
                                        <input type="number" class="form-control" id="gti_low" 
                                               value="0.01" step="0.01" min="0" max="1">
                                        <div class="form-text text-success">
                                            <strong>Description:</strong> Low alert threshold for minimal GTI activity during normal operations. 
                                            Represents expected precision limits and measurement uncertainties in timing systems. 
                                            Values below this indicate optimal system performance with minimal external influences. 
                                            Standard value 0.01 defines baseline noise floor for timing correlations.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="button" class="btn btn-primary" onclick="saveConfiguration()">
                                        <i class="fas fa-save me-1"></i>Save Configuration
                                    </button>
                                    <button type="button" class="btn btn-secondary ms-2" onclick="loadConfiguration()">
                                        <i class="fas fa-undo me-1"></i>Reset to Defaults
                                    </button>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-success" onclick="validateConfiguration()">
                                        <i class="fas fa-check me-1"></i>Validate Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Status -->
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-1"></i>Recent Configuration Changes
                </h6>
            </div>
            <div class="card-body">
                <div id="config-history">
                    {% for name, config in configurations.items() %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>{{ name }}</strong>
                                <br>
                                <small class="text-muted">{{ config.description or 'No description' }}</small>
                            </div>
                            <div class="text-end">
                                <code>{{ config.get_value() }}</code>
                                <br>
                                <small class="text-muted">{{ config.updated_at.strftime('%m/%d %H:%M') }}</small>
                            </div>
                        </div>
                        {% if not loop.last %}<hr class="my-2">{% endif %}
                    {% endfor %}
                    
                    {% if not configurations %}
                        <p class="text-muted mb-0">No configuration changes recorded.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-1"></i>Configuration Guidelines
                </h6>
            </div>
            <div class="card-body">
                <div class="accordion" id="guidelines-accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#multitaper-guide">
                                Multitaper Settings
                            </button>
                        </h2>
                        <div id="multitaper-guide" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <ul class="mb-0">
                                    <li><strong>NW = 4:</strong> Good balance for most applications</li>
                                    <li><strong>K = 2*NW - 1:</strong> Maximum number of reliable tapers</li>
                                    <li><strong>Higher NW:</strong> Better frequency resolution, more variance</li>
                                    <li><strong>Lower NW:</strong> Less resolution, lower variance</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#coherence-guide">
                                Coherence Analysis
                            </button>
                        </h2>
                        <div id="coherence-guide" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <ul class="mb-0">
                                    <li><strong>Threshold 0.1:</strong> Moderate coherence requirement</li>
                                    <li><strong>Smoothing 50:</strong> Balances noise vs. responsiveness</li>
                                    <li><strong>Lower threshold:</strong> More sensitive, more false positives</li>
                                    <li><strong>Higher threshold:</strong> Less sensitive, fewer detections</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#gti-guide">
                                GTI Thresholds
                            </button>
                        </h2>
                        <div id="gti-guide" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <ul class="mb-0">
                                    <li><strong>Critical ≥ 0.2:</strong> Immediate attention required</li>
                                    <li><strong>High ≥ 0.1:</strong> Elevated monitoring needed</li>
                                    <li><strong>Medium ≥ 0.05:</strong> Watch for trends</li>
                                    <li><strong>Low ≥ 0.01:</strong> Background monitoring</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function saveConfiguration() {
        const config = {
            multitaper_bandwidth: parseFloat(document.getElementById('multitaper_bandwidth').value),
            multitaper_samples: parseInt(document.getElementById('multitaper_samples').value),
            coherence_threshold: parseFloat(document.getElementById('coherence_threshold').value),
            phase_smoothing_window: parseInt(document.getElementById('phase_smoothing_window').value),
            bayes_factor_threshold: parseFloat(document.getElementById('bayes_factor_threshold').value),
            prior_strength: parseFloat(document.getElementById('prior_strength').value),
            use_mesh_monitor: document.getElementById('use_mesh_monitor').checked,
            mesh_peers: document.getElementById('mesh_peers').value.split('\n').filter(peer => peer.trim()),
            mesh_interval: parseInt(document.getElementById('mesh_interval').value),
            gti_thresholds: {
                critical: parseFloat(document.getElementById('gti_critical').value),
                high: parseFloat(document.getElementById('gti_high').value),
                medium: parseFloat(document.getElementById('gti_medium').value),
                low: parseFloat(document.getElementById('gti_low').value)
            }
        };

        // Save each configuration parameter
        const savePromises = Object.entries(config).map(([key, value]) => {
            return fetch('/api/update_configuration', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    parameter_name: key,
                    parameter_value: value
                })
            });
        });

        Promise.all(savePromises)
            .then(responses => {
                if (responses.every(r => r.ok)) {
                    showAlert('Configuration saved successfully!', 'success');
                } else {
                    showAlert('Some configuration parameters failed to save.', 'warning');
                }
            })
            .catch(error => {
                showAlert('Error saving configuration: ' + error.message, 'danger');
            });
    }

    function loadConfiguration() {
        // Reset to default values
        document.getElementById('multitaper_bandwidth').value = 4.0;
        document.getElementById('multitaper_samples').value = 7;
        document.getElementById('coherence_threshold').value = 0.1;
        document.getElementById('phase_smoothing_window').value = 50;
        document.getElementById('bayes_factor_threshold').value = 10.0;
        document.getElementById('prior_strength').value = 1.0;
        document.getElementById('use_mesh_monitor').checked = true;
        document.getElementById('mesh_peers').value = 'pool.ntp.org\ntime.nist.gov\ntime.google.com\nptbtime1.ptb.de';
        document.getElementById('mesh_interval').value = 60;
        document.getElementById('gti_critical').value = 0.2;
        document.getElementById('gti_high').value = 0.1;
        document.getElementById('gti_medium').value = 0.05;
        document.getElementById('gti_low').value = 0.01;
        
        toggleMeshConfig();
        showAlert('Configuration reset to defaults.', 'info');
    }

    function validateConfiguration() {
        const errors = [];
        
        // Validate multitaper parameters
        const nw = parseFloat(document.getElementById('multitaper_bandwidth').value);
        const k = parseInt(document.getElementById('multitaper_samples').value);
        
        if (k >= 2 * nw) {
            errors.push('Number of tapers (K) should be less than 2*NW for reliability.');
        }
        
        // Validate mesh monitor settings
        if (document.getElementById('use_mesh_monitor').checked) {
            const peers = document.getElementById('mesh_peers').value.split('\n').filter(peer => peer.trim());
            if (peers.length < 2) {
                errors.push('At least 2 NTP peers are recommended for reliable mesh monitoring.');
            }
            
            const interval = parseInt(document.getElementById('mesh_interval').value);
            if (interval < 10) {
                errors.push('Mesh polling interval should be at least 10 seconds to avoid overwhelming NTP servers.');
            }
        }
        
        // Validate threshold ordering
        const thresholds = [
            parseFloat(document.getElementById('gti_low').value),
            parseFloat(document.getElementById('gti_medium').value),
            parseFloat(document.getElementById('gti_high').value),
            parseFloat(document.getElementById('gti_critical').value)
        ];
        
        for (let i = 1; i < thresholds.length; i++) {
            if (thresholds[i] <= thresholds[i-1]) {
                errors.push('GTI thresholds must be in ascending order: Low < Medium < High < Critical');
                break;
            }
        }
        
        if (errors.length === 0) {
            showAlert('Configuration validation passed!', 'success');
        } else {
            showAlert('Validation errors: ' + errors.join(' '), 'danger');
        }
    }

    function toggleMeshConfig() {
        const isEnabled = document.getElementById('use_mesh_monitor').checked;
        const peersConfig = document.getElementById('mesh_peers_config');
        const intervalConfig = document.getElementById('mesh_interval_config');
        
        peersConfig.style.display = isEnabled ? 'block' : 'none';
        intervalConfig.style.display = isEnabled ? 'block' : 'none';
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Initialize mesh config toggle on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('use_mesh_monitor').addEventListener('change', toggleMeshConfig);
        toggleMeshConfig(); // Set initial state
    });
</script>
{% endblock %}
