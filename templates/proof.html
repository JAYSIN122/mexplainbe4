{% extends "base.html" %}

{% block title %}Proof - Temporal Monitoring{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-shield-alt me-2"></i>Proof It's Real
            </h2>

            <div class="row">
                <!-- Network Proofs -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-network-wired me-1"></i>Network Verification
                            </h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary me-2 mb-2" onclick="ping('https://webtai.bipm.org/ftp/pub/tai/other-products/utcrlab/')">
                                Ping BIPM
                            </button>
                            <button class="btn btn-primary me-2 mb-2" onclick="ping('https://datacenter.iers.org/data/9/dut1.txt')">
                                Ping IERS
                            </button>
                            <button class="btn btn-success me-2 mb-2" onclick="pull()">
                                Pull Now
                            </button>
                            <button class="btn btn-info mb-2" onclick="loadProv()">
                                Show Provenance
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analysis Proofs -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-1"></i>Analysis Verification
                            </h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-warning me-2 mb-2" onclick="fetchJson('/api/forecast')">
                                Current Forecast
                            </button>
                            <button class="btn btn-warning me-2 mb-2" onclick="fetchJson('/api/eta')">
                                ETA Analysis
                            </button>
                            <button class="btn btn-secondary me-2 mb-2" onclick="fetchJson('/api/last_trace')">
                                Last Traceback
                            </button>
                            <button class="btn btn-secondary mb-2" onclick="fetchJson('/api/logs?k=300')">
                                Tail Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<dialog id="m_ping" class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Ping Results</h5>
            <button type="button" class="btn-close" onclick="closeModal('m_ping')"></button>
        </div>
        <div class="modal-body">
            <pre id="ping_content">Loading...</pre>
        </div>
    </div>
</dialog>

<dialog id="m_prov" class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Provenance Records</h5>
            <button type="button" class="btn-close" onclick="closeModal('m_prov')"></button>
        </div>
        <div class="modal-body">
            <pre id="prov_content">Loading...</pre>
        </div>
    </div>
</dialog>

<dialog id="m_forecast" class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Forecast Data</h5>
            <button type="button" class="btn-close" onclick="closeModal('m_forecast')"></button>
        </div>
        <div class="modal-body">
            <pre id="forecast_content">Loading...</pre>
        </div>
    </div>
</dialog>

<dialog id="m_logs" class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">System Information</h5>
            <button type="button" class="btn-close" onclick="closeModal('m_logs')"></button>
        </div>
        <div class="modal-body">
            <pre id="logs_content">Loading...</pre>
        </div>
    </div>
</dialog>

<style>
dialog {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    max-width: 80vw;
    max-height: 80vh;
    overflow: auto;
}

dialog::backdrop {
    background: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
}

.modal-header {
    border-bottom: 1px solid var(--bs-border-color);
    padding: 1rem;
}

.modal-body {
    padding: 1rem;
}

.modal-body pre {
    max-height: 400px;
    overflow-y: auto;
    background: var(--bs-dark);
    color: var(--bs-light);
    padding: 1rem;
    border-radius: 0.25rem;
}
</style>

<script>
async function ping(url) {
    openModal('m_ping');
    document.getElementById('ping_content').textContent = 'Pinging...';

    try {
        const response = await fetch(`/api/ping?url=${encodeURIComponent(url)}`);
        const data = await response.json();
        document.getElementById('ping_content').textContent = JSON.stringify(data, null, 2);
    } catch (error) {
        document.getElementById('ping_content').textContent = `Error: ${error.message}`;
    }
}

async function pull() {
    openModal('m_prov');
    document.getElementById('prov_content').textContent = 'Pulling data...';

    try {
        const response = await fetch('/api/pull', { method: 'POST' });
        const data = await response.json();
        document.getElementById('prov_content').textContent = JSON.stringify(data, null, 2);
    } catch (error) {
        document.getElementById('prov_content').textContent = `Error: ${error.message}`;
    }
}

async function loadProv() {
    openModal('m_prov');
    document.getElementById('prov_content').textContent = 'Loading provenance...';

    try {
        const response = await fetch('/api/provenance?n=10');
        const data = await response.json();
        document.getElementById('prov_content').textContent = JSON.stringify(data, null, 2);
    } catch (error) {
        document.getElementById('prov_content').textContent = `Error: ${error.message}`;
    }
}

async function fetchJson(path) {
    const modal = path.includes('forecast') ? 'm_forecast' : 'm_logs';
    const content = path.includes('forecast') ? 'forecast_content' : 'logs_content';

    openModal(modal);
    document.getElementById(content).textContent = 'Loading...';

    try {
        const response = await fetch(path);
        const data = await response.json();
        document.getElementById(content).textContent = JSON.stringify(data, null, 2);
    } catch (error) {
        document.getElementById(content).textContent = `Error: ${error.message}`;
    }
}

function openModal(id) {
    document.getElementById(id).showModal();
}

function closeModal(id) {
    document.getElementById(id).close();
}
</script>
{% endblock %}